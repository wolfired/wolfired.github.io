---
layout: post
---
终于下定决心要编译V8引擎，这里记录编译过程中的一些关键点
# Arch Linux
* 安装Python：要安装2.x版本
* 翻墙：
* 安装[depot_tools][depot_tools_tutorial]：
    * `$ git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git`
    * `$ export PATH=/path/to/depot_tools:$PATH`
    * `$ gclient`，程序会自动更新所依赖的工具
# Windows 10
* 安装Python：要安装2.x版本
* 翻墙：直接用全局VPN
* 安装[depot_tools][depot_tools_tutorial]：
    * 下载[程序包][depot_tools_bundle]并且解压，**注意：要完整解压**
    * 添加`PATH`路径，**注意：要添加到最前面**
    * 安装设置完毕后，打开`CMD`直接运行`gclient`，程序会自动更新所依赖的工具
* 安装VS：
    * 安装`VS2017`，必须要安装`Desktop development with C++`与`MFC and ATL support`
    * 安装`Windows 10 SDK`，一般在安装`VS2017`时会附带安装上，不过这时要手工去安装`Debugging Tools For Windows`，方法：`控制面板`->`程序`->`程序和功能`->找到`Windows Software Development Kit`->`更改`->选中`更改`，点`下一步`->勾选`Debugging Tools For Windows`，确认`更改`
* 环境变量：
```
DEPOT_TOOLS_WIN_TOOLCHAIN：是否使用depot_tools自带的Windows编译工具链，请设置为0
GYP_MSVS_VERSION：指定VS版本，默认值是2017，如果是旧版本，请设置
GYP_MSVS_OVERRIDE_PATH: 指定VS安装路径，如果是自定义安装路径，请设置
```
* 下载源码`fetch v8`，只需要执行一次
* 同步工程`gclient sync`

# 安装时用到的几个命令
下面以Linux Terminal为例，Windows Command Line请自行作相应修改   
首先进入V8的源码目录
## `./tools/dev/v8gen.py`
此脚本其实只是`gn`命令的封装
* `./tools/dev/v8gen.py list`打印所有支持的编译模式，如:   
```
x64.debug
x64.release
```
* `./tools/dev/v8gen.py gen`生成构建目录，`gen`是默认行为，可以省略，如：
```bash
# 默认在out.gn目录下生成构建目录x64.release
$ ./tools/dev/v8gen.py gen x64.release
$ ./tools/dev/v8gen.py     x64.release
# 也可以自定义构建目录
$ ./tools/dev/v8gen.py gen -b x64.release ~/some_path/my_build_dir
```
## `gn`
* `gn args out.gn/x64.debug --list`打印指定构建目录的所有构建参数的当前值与默认值
* `gn args out.gn/x64.debug`编辑指定构建目录的构建参数
    >当然你也可以直接编辑`out.gn/x64.debug/args.gn`文件
## `ninja`
* `ninja -C out.gn/x64.debug`完全编译，后面也可以指定构建目标，如：
```bash
$ ninja -C out.gn/x64.debug v8
```
# `args.gn`文件的几个关键构建参数
```bash
# 是否调试编译
is_debug = false
# CPU架构，x64是指64位，x86是32位
target_cpu = "x64"
# Windows下编译时报错了，Google之，有提到这个参数，指定后正常编译，具体意义有待查证
v8_target_cpu = "x64"
# 是否编译动态库
is_component_build = true
# 是否编译静态库
v8_static_library = false
# 是否使用快照模式？
v8_use_snapshot = false

```
[depot_tools_tutorial]: http://commondatastorage.googleapis.com/chrome-infra-docs/flat/depot_tools/docs/html/depot_tools_tutorial.html
[depot_tools_bundle]:https://storage.googleapis.com/chrome-infra/depot_tools.zip